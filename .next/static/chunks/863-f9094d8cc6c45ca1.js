(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[863],{7187:function(e){"use strict";var t,s="object"==typeof Reflect?Reflect:null,r=s&&"function"==typeof s.apply?s.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)};t=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}e.exports=i,e.exports.once=function(e,t){return new Promise(function(s,r){var n;function i(s){e.removeListener(t,a),r(s)}function a(){"function"==typeof e.removeListener&&e.removeListener("error",i),s([].slice.call(arguments))}g(e,t,a,{once:!0}),"error"!==t&&(n={once:!0},"function"==typeof e.on&&g(e,"error",i,n))})},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var a=10;function o(e){if("function"!=typeof e)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function c(e,t,s,r){if(o(s),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),i=e._events),a=i[t]),void 0===a)a=i[t]=s,++e._eventsCount;else if("function"==typeof a?a=i[t]=r?[s,a]:[a,s]:r?a.unshift(s):a.push(s),(n=l(e))>0&&a.length>n&&!a.warned){a.warned=!0;var n,i,a,c=Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,console&&console.warn&&console.warn(c)}return e}function u(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,s){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:s},n=u.bind(r);return n.listener=s,r.wrapFn=n,n}function p(e,t,s){var r=e._events;if(void 0===r)return[];var n=r[t];return void 0===n?[]:"function"==typeof n?s?[n.listener||n]:[n]:s?function(e){for(var t=Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}(n):m(n,n.length)}function h(e){var t=this._events;if(void 0!==t){var s=t[e];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function m(e,t){for(var s=Array(t),r=0;r<t;++r)s[r]=e[r];return s}function g(e,t,s,r){if("function"==typeof e.on)r.once?e.once(t,s):e.on(t,s);else if("function"==typeof e.addEventListener)e.addEventListener(t,function n(i){r.once&&e.removeEventListener(t,n),s(i)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||n(e))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),i.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return l(this)},i.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var n="error"===e,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var a,o=Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var l=i[e];if(void 0===l)return!1;if("function"==typeof l)r(l,this,t);else for(var c=l.length,u=m(l,c),s=0;s<c;++s)r(u[s],this,t);return!0},i.prototype.addListener=function(e,t){return c(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return c(this,e,t,!0)},i.prototype.once=function(e,t){return o(t),this.on(e,d(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return o(t),this.prependListener(e,d(this,e,t)),this},i.prototype.removeListener=function(e,t){var s,r,n,i,a;if(o(t),void 0===(r=this._events)||void 0===(s=r[e]))return this;if(s===t||s.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(n=-1,i=s.length-1;i>=0;i--)if(s[i]===t||s[i].listener===t){a=s[i].listener,n=i;break}if(n<0)return this;0===n?s.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(s,n),1===s.length&&(r[e]=s[0]),void 0!==r.removeListener&&this.emit("removeListener",e,a||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,s,r;if(void 0===(s=this._events))return this;if(void 0===s.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete s[e]),this;if(0==arguments.length){var n,i=Object.keys(s);for(r=0;r<i.length;++r)"removeListener"!==(n=i[r])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},i.prototype.listeners=function(e){return p(this,e,!0)},i.prototype.rawListeners=function(e){return p(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},i.prototype.listenerCount=h,i.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},7338:function(e,t,s){"use strict";var r=s(5893),n=s(7294),i=s(1798);let a=e=>{let{message:t,isOwnMessage:s,getUserDisplayName:i,onAddReaction:a,formatTime:o}=e,[l,c]=(0,n.useState)(!1);return"system"===t.type?(0,r.jsx)("div",{className:"text-center",children:(0,r.jsx)("span",{className:"text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full",children:t.content})}):(0,r.jsx)("div",{className:"flex ".concat(s?"justify-end":"justify-start"),children:(0,r.jsxs)("div",{className:"max-w-xs lg:max-w-md ".concat(s?"order-1":"order-2"),children:[(0,r.jsxs)("div",{className:"px-4 py-2 rounded-lg ".concat(s?"bg-blue-600 text-white":"bg-white border border-gray-200"),children:[!s&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:i(t.senderId)}),"voice"===t.type&&t.voiceData?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{className:"text-lg",children:"\uD83C\uDFB5"}),(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsx)("audio",{controls:!0,src:t.voiceData.audioUrl,className:"w-full"})})]}):(0,r.jsx)("div",{children:t.content}),(0,r.jsx)("div",{className:"flex items-center justify-between mt-1",children:(0,r.jsx)("span",{className:"text-xs ".concat(s?"text-blue-100":"text-gray-500"),children:o(t.timestamp)})})]}),t.reactions.length>0&&(0,r.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:Array.from(new Set(t.reactions.map(e=>e.emoji))).map(e=>{let s=t.reactions.filter(t=>t.emoji===e).length;return(0,r.jsxs)("button",{onClick:()=>a(t.id,e),className:"inline-flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-xs",children:[(0,r.jsx)("span",{children:e}),(0,r.jsx)("span",{children:s})]},e)})}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("button",{onClick:()=>c(!l),className:"text-gray-400 hover:text-gray-600 text-sm mt-1",children:"React"}),l&&(0,r.jsx)("div",{className:"absolute bottom-full mb-2 bg-white border border-gray-200 rounded-lg shadow-lg p-2 flex gap-1 z-10",children:["\uD83D\uDC4D","❤️","\uD83D\uDE0A","\uD83D\uDE4F","\uD83D\uDCAA","\uD83E\uDD1D"].map(e=>(0,r.jsx)("button",{onClick:()=>{a(t.id,e),c(!1)},className:"text-lg hover:bg-gray-100 p-1 rounded",children:e},e))})]})]})})},o=e=>{let{availableGroups:t,onJoinGroup:s,onClose:i,getGroupIcon:a}=e,[o,l]=(0,n.useState)(""),[c,u]=(0,n.useState)("all"),d=t.filter(e=>{let t=e.name.toLowerCase().includes(o.toLowerCase())||e.description.toLowerCase().includes(o.toLowerCase()),s="all"===c||e.type===c;return t&&s});return(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden",children:[(0,r.jsxs)("div",{className:"p-6 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Browse Support Groups"}),(0,r.jsx)("button",{onClick:i,className:"text-gray-400 hover:text-gray-600",children:"✕"})]}),(0,r.jsxs)("div",{className:"mt-4 space-y-3",children:[(0,r.jsx)("input",{type:"text",value:o,onChange:e=>l(e.target.value),placeholder:"Search groups...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),(0,r.jsx)("select",{value:c,onChange:e=>u(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[{value:"all",label:"All Groups"},{value:"language",label:"Language Groups"},{value:"country",label:"Country Groups"},{value:"interest",label:"Interest Groups"},{value:"support_topic",label:"Support Topics"}].map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))})]})]}),(0,r.jsxs)("div",{className:"p-6 overflow-y-auto max-h-96",children:[(0,r.jsx)("div",{className:"space-y-3",children:d.map(e=>(0,r.jsx)("div",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 flex-1",children:[(0,r.jsx)("span",{className:"text-2xl",children:a(e.type)}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h3",{className:"font-medium",children:e.name}),(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:e.description}),(0,r.jsxs)("div",{className:"flex items-center gap-4 mt-2 text-xs text-gray-500",children:[(0,r.jsxs)("span",{children:[e.members.length," members"]}),(0,r.jsx)("span",{className:"capitalize",children:e.type.replace("_"," ")}),e.settings.requireApproval&&(0,r.jsx)("span",{className:"text-yellow-600",children:"Requires approval"})]})]})]}),(0,r.jsx)("button",{onClick:()=>s(e.id),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Join"})]})},e.id))}),0===d.length&&(0,r.jsx)("div",{className:"text-center py-8 text-gray-500",children:"No groups found matching your criteria."})]})]})})};t.Z=e=>{var t,s,l;let{userId:c,chatSystem:u,onClose:d}=e,{t:p}=(0,i.$G)("common"),[h,m]=(0,n.useState)(null),[g,f]=(0,n.useState)([]),[v,x]=(0,n.useState)([]),[y,b]=(0,n.useState)(null),[w,j]=(0,n.useState)([]),[N,D]=(0,n.useState)(""),[C,_]=(0,n.useState)(!1),[S,L]=(0,n.useState)(!1),[M,G]=(0,n.useState)([]),A=(0,n.useRef)(null),E=(0,n.useRef)(null),O=(0,n.useRef)([]);(0,n.useEffect)(()=>(k(),F(),()=>{I()}),[c]);let k=async()=>{try{let e=await R(),t=await u.registerUser(e);m(t),await J(),await K()}catch(e){console.error("Failed to initialize chat:",e)}},R=async()=>({displayName:"User".concat(Math.floor(1e3*Math.random())),languagePreferences:["en"],interests:["mental_health","peer_support"],privacySettings:{showCountryOfOrigin:!1,showLanguages:!0,allowDirectMessages:!0,dataRetention:"standard"}}),F=()=>{u.on("message_sent",U),u.on("user_joined",P),u.on("user_left",T),u.on("reaction_added",B),u.on("notification",z)},I=()=>{u.removeAllListeners()},U=e=>{e.groupId===y&&(j(t=>[...t,e]),Q())},P=e=>{let{userId:t,groupId:s}=e;s===y&&W(s)},T=e=>{let{userId:t,groupId:s}=e;s===y&&W(s)},B=e=>{let{messageId:t,userId:s,emoji:r}=e;j(e=>e.map(e=>e.id===t?{...e,reactions:[...e.reactions.filter(e=>e.userId!==s),{emoji:r,userId:s,timestamp:new Date}]}:e))},z=e=>{G(t=>[...t,e]),setTimeout(()=>{G(t=>t.filter(t=>t!==e))},5e3)},J=async()=>{let e=[];x(e),e.length>0&&!y&&(b(e[0].id),await W(e[0].id))},K=async()=>{f([])},W=async e=>{try{let t=await u.getGroupMessages(e,c,50,0);j(t),Q()}catch(e){console.error("Failed to load messages:",e)}},q=async()=>{if(N.trim()&&y)try{await u.sendMessage(c,y,N.trim()),D("")}catch(e){console.error("Failed to send message:",e)}},H=async()=>{try{let e=await navigator.mediaDevices.getUserMedia({audio:!0}),t=new MediaRecorder(e);E.current=t,O.current=[],t.ondataavailable=e=>{e.data.size>0&&O.current.push(e.data)},t.onstop=async()=>{let t=new Blob(O.current,{type:"audio/wav"});await V(t),e.getTracks().forEach(e=>e.stop())},t.start(),_(!0)}catch(e){console.error("Failed to start recording:",e)}},V=async e=>{if(!y)return;let t={audioUrl:URL.createObjectURL(e),duration:0,language:(null==h?void 0:h.languagePreferences[0])||"en"};try{await u.sendMessage(c,y,"","voice",t)}catch(e){console.error("Failed to send voice message:",e)}},Y=async(e,t)=>{try{await u.addReaction(c,e,t)}catch(e){console.error("Failed to add reaction:",e)}},Z=async e=>{try{await u.joinGroup(c,e)&&(await J(),b(e),await W(e),L(!1))}catch(e){console.error("Failed to join group:",e)}},$=async e=>{try{if(await u.leaveGroup(c,e)&&(await J(),y===e)){var t;b((null===(t=v[0])||void 0===t?void 0:t.id)||null),v[0]&&await W(v[0].id)}}catch(e){console.error("Failed to leave group:",e)}},Q=()=>{var e;null===(e=A.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},X=e=>new Intl.DateTimeFormat("en",{hour:"2-digit",minute:"2-digit"}).format(e),ee=e=>({language:"\uD83C\uDF10",country:"\uD83C\uDFE0",interest:"\uD83D\uDCAD",support_topic:"\uD83E\uDD1D",general:"\uD83D\uDCAC"})[e]||"\uD83D\uDCAC",et=e=>"system"===e?"System":e===c?"You":"User".concat(e.slice(-4));return((0,n.useEffect)(()=>{Q()},[w]),h)?(0,r.jsxs)("div",{className:"flex h-screen bg-gray-100",children:[(0,r.jsxs)("div",{className:"w-1/4 bg-white border-r border-gray-200 flex flex-col",children:[(0,r.jsxs)("div",{className:"p-4 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold flex items-center gap-2",children:"\uD83D\uDCAC Peer Support Chat"}),d&&(0,r.jsx)("button",{onClick:d,className:"text-gray-400 hover:text-gray-600",children:"✕"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,r.jsx)("div",{className:"w-3 h-3 bg-green-400 rounded-full"}),(0,r.jsx)("span",{children:h.displayName})]})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,r.jsxs)("div",{className:"p-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-700",children:"My Groups"}),(0,r.jsx)("button",{onClick:()=>L(!0),className:"text-blue-600 hover:text-blue-800 text-sm",children:"Browse"})]}),(0,r.jsx)("div",{className:"space-y-1",children:v.map(e=>(0,r.jsx)("button",{onClick:()=>{b(e.id),W(e.id)},className:"w-full text-left p-3 rounded-lg hover:bg-gray-50 transition-colors ".concat(y===e.id?"bg-blue-50 border border-blue-200":""),children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("span",{className:"text-xl",children:ee(e.type)}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("div",{className:"font-medium text-sm truncate",children:e.name}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 truncate",children:[e.members.length," members"]})]})]})},e.id))})]})}),(0,r.jsxs)("div",{className:"p-3 border-t border-gray-200 bg-gray-50",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,r.jsx)("span",{className:"text-lg",children:"\uD83C\uDFC6"}),(0,r.jsx)("span",{className:"text-sm font-medium",children:"Your Badges"})]}),(0,r.jsx)("div",{className:"flex flex-wrap gap-1",children:h.badges.map(e=>(0,r.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full",title:e.description,children:[(0,r.jsx)("span",{children:e.icon}),(0,r.jsx)("span",{children:e.name})]},e.id))}),(0,r.jsxs)("div",{className:"mt-2 text-xs text-gray-600",children:["Trust Score: ",h.trustScore,"/100"]})]})]}),(0,r.jsx)("div",{className:"flex-1 flex flex-col",children:y?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"p-4 border-b border-gray-200 bg-white",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h3",{className:"font-medium flex items-center gap-2",children:[(0,r.jsx)("span",{children:ee((null===(t=v.find(e=>e.id===y))||void 0===t?void 0:t.type)||"general")}),null===(s=v.find(e=>e.id===y))||void 0===s?void 0:s.name]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:[null===(l=v.find(e=>e.id===y))||void 0===l?void 0:l.members.length," members"]})]}),(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsx)("button",{onClick:()=>$(y),className:"text-red-600 hover:text-red-800 text-sm px-3 py-1 border border-red-200 rounded-md hover:bg-red-50",children:"Leave Group"})})]})}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50",children:[w.map(e=>(0,r.jsx)(a,{message:e,isOwnMessage:e.senderId===c,getUserDisplayName:et,onAddReaction:Y,formatTime:X},e.id)),(0,r.jsx)("div",{ref:A})]}),(0,r.jsx)("div",{className:"p-4 border-t border-gray-200 bg-white",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"flex-1 relative",children:(0,r.jsx)("input",{type:"text",value:N,onChange:e=>D(e.target.value),onKeyPress:e=>"Enter"===e.key&&q(),placeholder:"Type your message...",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})}),(0,r.jsx)("button",{onClick:C?()=>{E.current&&C&&(E.current.stop(),_(!1))}:H,className:"p-2 rounded-lg transition-colors ".concat(C?"bg-red-600 text-white animate-pulse":"bg-gray-100 hover:bg-gray-200 text-gray-600"),children:"\uD83C\uDFA4"}),(0,r.jsx)("button",{onClick:q,disabled:!N.trim(),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:"Send"})]})})]}):(0,r.jsx)("div",{className:"flex-1 flex items-center justify-center bg-gray-50",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-6xl mb-4",children:"\uD83D\uDCAC"}),(0,r.jsx)("h3",{className:"text-lg font-medium text-gray-800 mb-2",children:"Welcome to Peer Support Chat"}),(0,r.jsx)("p",{className:"text-gray-600 mb-4",children:"Select a group to start chatting with peers who understand your journey"}),(0,r.jsx)("button",{onClick:()=>L(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Browse Groups"})]})})}),S&&(0,r.jsx)(o,{availableGroups:g,onJoinGroup:Z,onClose:()=>L(!1),getGroupIcon:ee}),(0,r.jsx)("div",{className:"fixed top-4 right-4 space-y-2 z-50",children:M.map((e,t)=>(0,r.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg shadow-lg p-3 max-w-sm",children:(0,r.jsx)("div",{className:"text-sm",children:e.data.message})},t))})]}):(0,r.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin text-4xl mb-4",children:"\uD83D\uDD04"}),(0,r.jsx)("p",{children:"Loading chat system..."})]})})}},4160:function(e,t,s){"use strict";var r=s(7187);class n extends r.EventEmitter{async registerUser(e){var t,s,r,n,i,a,o;let l={id:"user_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),anonymousId:"anonymous_".concat(Math.random().toString(36).substr(2,12)),displayName:e.displayName||"User".concat(Math.floor(1e3*Math.random())),avatar:e.avatar,languagePreferences:e.languagePreferences||["en"],countryOfOrigin:e.countryOfOrigin,interests:e.interests||[],trustScore:50,badges:[],joinedAt:new Date,lastActive:new Date,isOnline:!1,privacySettings:{showCountryOfOrigin:null!==(i=null===(t=e.privacySettings)||void 0===t?void 0:t.showCountryOfOrigin)&&void 0!==i&&i,showLanguages:null===(a=null===(s=e.privacySettings)||void 0===s?void 0:s.showLanguages)||void 0===a||a,allowDirectMessages:null===(o=null===(r=e.privacySettings)||void 0===r?void 0:r.allowDirectMessages)||void 0===o||o,dataRetention:(null===(n=e.privacySettings)||void 0===n?void 0:n.dataRetention)||"standard"}};return this.users.set(l.id,l),this.userGroups.set(l.id,[]),await this.autoJoinGroups(l.id),this.emit("user_registered",l),l}async updateUserPreferences(e,t){let s=this.users.get(e);if(!s)throw Error("User not found");Object.assign(s,t),this.users.set(e,s),(t.languagePreferences||t.countryOfOrigin||t.interests)&&await this.autoJoinGroups(e)}async setUserOnlineStatus(e,t){let s=this.users.get(e);s&&(s.isOnline=t,s.lastActive=new Date,this.users.set(e,s),(this.userGroups.get(e)||[]).forEach(s=>{this.emit("user_status_changed",{userId:e,groupId:s,isOnline:t})}))}async createGroup(e,t){let s={id:"group_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),name:e.name||"New Group",description:e.description||"",type:e.type||"general",criteria:e.criteria||{},members:[t],moderators:[t],settings:{isPublic:!0,requireApproval:!1,allowVoiceMessages:!0,autoModeration:!0,retentionDays:30,notificationsEnabled:!0,...e.settings},createdAt:new Date,lastActivity:new Date,isActive:!0,maxMembers:e.maxMembers||50,rules:e.rules||this.getDefaultGroupRules()};this.groups.set(s.id,s),this.messages.set(s.id,[]);let r=this.userGroups.get(t)||[];return r.push(s.id),this.userGroups.set(t,r),this.emit("group_created",s),s}async joinGroup(e,t){let s=this.users.get(e),r=this.groups.get(t);if(!s||!r)return!1;if(r.members.includes(e))return!0;if(r.members.length>=r.maxMembers||!this.meetsGroupCriteria(s,r.criteria))return!1;r.members.push(e),r.lastActivity=new Date,this.groups.set(t,r);let n=this.userGroups.get(e)||[];return n.push(t),this.userGroups.set(e,n),await this.sendSystemMessage(t,"".concat(s.displayName," joined the group"),"user_joined"),this.emit("user_joined",{userId:e,groupId:t}),!0}async leaveGroup(e,t){let s=this.users.get(e),r=this.groups.get(t);if(!s||!r)return!1;if(r.members=r.members.filter(t=>t!==e),r.moderators=r.moderators.filter(t=>t!==e),0===r.moderators.length&&r.members.length>0){let e=r.members.reduce((e,t)=>{let s=this.users.get(e),r=this.users.get(t);return((null==r?void 0:r.trustScore)||0)>((null==s?void 0:s.trustScore)||0)?t:e});r.moderators.push(e)}this.groups.set(t,r);let n=this.userGroups.get(e)||[];return this.userGroups.set(e,n.filter(e=>e!==t)),await this.sendSystemMessage(t,"".concat(s.displayName," left the group"),"user_left"),this.emit("user_left",{userId:e,groupId:t}),!0}async sendMessage(e,t,s){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"text",n=arguments.length>4?arguments[4]:void 0,i=this.users.get(e),a=this.groups.get(t);if(!i||!a||!a.members.includes(e))return null;let o=await this.moderateContent(s,e),l={id:"msg_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),groupId:t,senderId:e,content:o.approved?s:"[Message hidden by moderation]",type:r,voiceData:n,reactions:[],timestamp:new Date,isModerated:!o.approved,moderationFlag:o.flag,isEncrypted:!0,expiresAt:this.calculateMessageExpiration(a.settings.retentionDays)},c=this.messages.get(t)||[];return c.push(l),this.messages.set(t,c),a.lastActivity=new Date,this.groups.set(t,a),await this.checkAndAwardBadges(e),this.emit("message_sent",l),l}async addReaction(e,t,s){for(let[r,n]of this.messages){let i=n.find(e=>e.id===t);if(i){let n=this.groups.get(r);if(!(null==n?void 0:n.members.includes(e)))return!1;return i.reactions=i.reactions.filter(t=>t.userId!==e),i.reactions.push({emoji:s,userId:e,timestamp:new Date}),this.emit("reaction_added",{messageId:t,userId:e,emoji:s}),!0}}return!1}async getGroupMessages(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=this.groups.get(e);return(null==n?void 0:n.members.includes(t))?(this.messages.get(e)||[]).filter(e=>!e.expiresAt||e.expiresAt>new Date).slice(-s-r,-r||void 0).reverse():[]}async autoJoinGroups(e){let t=this.users.get(e);if(t)for(let[s,r]of this.groups)r.isActive&&r.settings.isPublic&&!r.members.includes(e)&&r.members.length<r.maxMembers&&this.meetsGroupCriteria(t,r.criteria)&&await this.joinGroup(e,s)}meetsGroupCriteria(e,t){var s,r,n;return(null===(s=t.languages)||void 0===s||!s.length||!!t.languages.some(t=>e.languagePreferences.includes(t)))&&(null===(r=t.countries)||void 0===r||!r.length||!e.privacySettings.showCountryOfOrigin||!!t.countries.includes(e.countryOfOrigin||""))&&(null===(n=t.interests)||void 0===n||!n.length||!!t.interests.some(t=>e.interests.includes(t)))&&(!t.minTrustScore||!(e.trustScore<t.minTrustScore))}async moderateContent(e,t){let s=this.users.get(t);if(!s)return{approved:!1};for(let t of[/\b(hate|harm|violence|abuse)\b/i,/\b(spam|scam|fraud)\b/i])if(t.test(e))return{approved:!1,flag:{reason:"inappropriate",action:"hide",reviewedAt:new Date}};return s.trustScore<20?{approved:!1,flag:{reason:"harmful",action:"remove",reviewedAt:new Date}}:{approved:!0}}async checkAndAwardBadges(e){var t;let s=this.users.get(e);if(!s)return;let r=await this.getUserMessageCount(e);null===(t=this.userGroups.get(e))||void 0===t||t.length,r>=10&&!s.badges.some(e=>"active_chatter"===e.id)&&s.badges.push({id:"active_chatter",name:"Active Chatter",description:"Sent 10 messages",icon:"\uD83D\uDCAC",earnedAt:new Date,type:"active"}),await this.getHelpfulReactionsCount(e)>=5&&!s.badges.some(e=>"helpful_friend"===e.id)&&(s.badges.push({id:"helpful_friend",name:"Helpful Friend",description:"Received 5 helpful reactions",icon:"\uD83E\uDD1D",earnedAt:new Date,type:"helper"}),s.trustScore=Math.min(100,s.trustScore+5)),this.users.set(e,s)}async getUserMessageCount(e){let t=0;for(let s of this.messages.values())t+=s.filter(t=>t.senderId===e).length;return t}async getHelpfulReactionsCount(e){let t=0,s=["\uD83D\uDC4D","❤️","\uD83D\uDE4F","\uD83D\uDCAA"];for(let r of this.messages.values())for(let n of r)n.senderId===e&&(t+=n.reactions.filter(e=>s.includes(e.emoji)).length);return t}async sendSystemMessage(e,t,s){let r={id:"sys_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),groupId:e,senderId:"system",content:t,type:"system",reactions:[],timestamp:new Date,isModerated:!1,isEncrypted:!1},n=this.messages.get(e)||[];n.push(r),this.messages.set(e,n)}calculateMessageExpiration(e){let t=new Date;return t.setDate(t.getDate()+e),t}startCleanupScheduler(){setInterval(()=>{this.cleanupExpiredMessages()},36e5)}cleanupExpiredMessages(){let e=new Date;for(let[t,s]of this.messages){let r=s.filter(t=>!t.expiresAt||t.expiresAt>e);this.messages.set(t,r)}}initializeDefaultGroups(){[{name:"English Support Circle",description:"General support in English",type:"language",criteria:{languages:["en"]}},{name:"华语互助圈 (Chinese Support)",description:"General support in Chinese",type:"language",criteria:{languages:["zh"]}},{name:"বাংলা সাহায্য (Bengali Support)",description:"General support in Bengali",type:"language",criteria:{languages:["bn"]}},{name:"New Arrivals Welcome",description:"Support for newcomers to Singapore",type:"support_topic",criteria:{interests:["newcomer_support"]}},{name:"Work Stress Support",description:"Dealing with workplace challenges",type:"support_topic",criteria:{interests:["work_stress"]}}].forEach(async e=>{await this.createGroup(e,"system")})}getDefaultGroupRules(){return["Be respectful and kind to all members","No personal attacks or harassment","Keep conversations supportive and constructive","Respect privacy - no sharing personal information","Use appropriate language for all ages","No spam or promotional content","Support each other's mental health journey"]}async sendNotification(e,t,s){this.users.get(e)&&this.emit("notification",{userId:e,type:t,data:s})}getGroupStats(e){let t=this.groups.get(e);if(!t)return null;let s=this.messages.get(e)||[],r=t.members.filter(e=>{let t=this.users.get(e);return(null==t?void 0:t.isOnline)||!1}).length;return{memberCount:t.members.length,messageCount:s.length,activeMembers:r,lastActivity:t.lastActivity}}async exportUserData(e){let t=this.users.get(e);return t?{profile:t,groups:this.userGroups.get(e)||[],messageCount:await this.getUserMessageCount(e)}:null}async deleteUserData(e){if(!this.users.get(e))return!1;for(let t of this.userGroups.get(e)||[])await this.leaveGroup(e,t);for(let t of this.messages.values())t.forEach(t=>{t.senderId===e&&(t.senderId="anonymous",t.content="[Message from deleted user]")});return this.users.delete(e),this.userGroups.delete(e),!0}constructor(){super(),this.users=new Map,this.groups=new Map,this.messages=new Map,this.userGroups=new Map,this.activeConnections=new Map,this.initializeDefaultGroups(),this.startCleanupScheduler()}}t.Z=n},9008:function(e,t,s){e.exports=s(3867)}}]);